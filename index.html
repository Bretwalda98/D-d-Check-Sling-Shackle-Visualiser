<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>D/d Check – Sling & Shackle Visualiser (ISO aligned)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --card2:#0b152e; --muted:#94a3b8; --text:#e5e7eb;
      --line:#1f2a44; --accent:#67e8f9; --good:#10b981; --warn:#eab308; --bad:#ef4444;
    }
    body{background:var(--bg); color:var(--text); font-family:sans-serif}
    .card{border-radius:1rem; box-shadow:0 10px 20px rgba(0,0,0,.18); background:var(--card)}
    .badge{font-size:.75rem; padding:.15rem .45rem; border-radius:.5rem}
    .good{background:var(--good); color:#052e22}
    .warn{background:var(--warn); color:#1f1a05}
    .bad{background:var(--bad); color:#fff}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header class="px-4 py-4">
    <h1 class="text-xl font-semibold">D/d Check – Sling & Shackle Visualiser (ISO 19901‑6)</h1>
    <p class="text-sm muted">Includes bending efficiency factor (K<sub>be</sub>), spinning loss (k), and safety factor check.</p>
  </header>

  <main class="max-w-5xl mx-auto p-4 space-y-4">
    <section class="card p-5">
      <h2 class="font-semibold mb-3">Inputs</h2>
      <div class="grid grid-cols-2 gap-3">
        <label> Sling diameter d <input id="d" type="number" value="100" step="any" class="w-full mt-1 px-2 py-1 rounded bg-slate-800"/></label>
        <label> Contact diameter D <input id="D" type="number" value="400" step="any" class="w-full mt-1 px-2 py-1 rounded bg-slate-800"/></label>
        <label> Diagram case
          <select id="case" class="w-full mt-1 px-2 py-1 rounded bg-slate-800">
            <option value="grommetPin">Endless grommet over pin</option>
            <option value="eyeShackle">Eye to shackle (straight)</option>
            <option value="basketObject">Basket over round object</option>
            <option value="basketPin">Basket over shackle body</option>
            <option value="doubleInShackle">Double sling in shackle</option>
          </select>
        </label>
        <label> Nominal safety factor γ <input id="gamma" type="number" value="5" step="any" class="w-full mt-1 px-2 py-1 rounded bg-slate-800"/></label>
        <label> Minimum required γ<sub>min</sub> <input id="gammaMin" type="number" value="3" step="any" class="w-full mt-1 px-2 py-1 rounded bg-slate-800"/></label>
      </div>
      <button onclick="recalc()" class="mt-3 px-3 py-2 rounded bg-sky-600 hover:bg-sky-500">Recalculate</button>
    </section>

    <section class="card p-5">
      <h2 class="font-semibold mb-3">Results</h2>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <div class="text-sm muted">D/d ratio</div>
          <div id="dd" class="text-xl font-semibold">–</div>
        </div>
        <div>
          <div class="text-sm muted">Bending efficiency K<sub>be</sub></div>
          <div id="kbe" class="text-xl font-semibold">–</div>
        </div>
        <div>
          <div class="text-sm muted">Spinning loss k (if cable‑laid)</div>
          <div id="kspin" class="text-xl font-semibold">–</div>
        </div>
        <div>
          <div class="text-sm muted">Reduced safety factor γ<sub>red</sub></div>
          <div id="gammaRed" class="text-xl font-semibold">–</div>
        </div>
      </div>
      <div class="mt-3 text-sm"><span id="status"></span></div>
    </section>

    <!-- Visualisation -->
    <section class="card p-5">
      <h2 class="font-semibold mb-3">Visualisation</h2>
      <canvas id="viz" width="800" height="400" class="w-full h-auto bg-[var(--card2)] rounded-lg"></canvas>
    </section>

    <section class="card p-5 text-sm space-y-2">
      <h2 class="font-semibold">Formulas used (ISO 19901‑6:2009)</h2>
      <p>D/d = D ÷ d</p>
      <p>K<sub>be</sub> = 1 − 0.5 / √(D/d)</p>
      <p>γ<sub>red</sub> = γ × K<sub>be</sub> × k (k=0.9 if cable‑laid, else 1.0)</p>
      <p>Check: γ<sub>red</sub> ≥ γ<sub>min</sub></p>
    </section>
  </main>

  <script>
    function fmt(x,dp=2){return isFinite(x)?(+x).toFixed(dp):'–'}

    function recalc(){
      const d = parseFloat(document.getElementById('d').value);
      const D = parseFloat(document.getElementById('D').value);
      const caseType = document.getElementById('case').value;
      const gamma = parseFloat(document.getElementById('gamma').value);
      const gammaMin = parseFloat(document.getElementById('gammaMin').value);

      if(!(d>0 && D>0 && gamma>0)) return;

      const r = D/d;
      const kbe = 1 - 0.5/Math.sqrt(r);
      const kspin = 1.0;
      const gammaRed = gamma * kbe * kspin;

      document.getElementById('dd').textContent = fmt(r,2)+':1';
      document.getElementById('kbe').textContent = fmt(kbe,3);
      document.getElementById('kspin').textContent = kspin.toFixed(2);
      document.getElementById('gammaRed').textContent = fmt(gammaRed,2);

      const statusEl = document.getElementById('status');
      if(gammaRed >= gammaMin){
        statusEl.innerHTML = `<span class="badge good">OK</span> Reduced safety factor ${fmt(gammaRed,2)} ≥ γmin ${fmt(gammaMin,2)}`;
      } else {
        statusEl.innerHTML = `<span class="badge bad">NOT OK</span> Reduced safety factor ${fmt(gammaRed,2)} < γmin ${fmt(gammaMin,2)}`;
      }

      drawCase(caseType,{D,d,ratio:r});
    }

    function line(g, x1,y1,x2,y2, w, col){ g.strokeStyle=col; g.lineWidth=w; g.beginPath(); g.moveTo(x1,y1); g.lineTo(x2,y2); g.stroke(); }
    function arc(g, cx,cy,r, a0,a1, w, col){ g.strokeStyle=col; g.lineWidth=w; g.beginPath(); g.arc(cx,cy,r,a0,a1); g.stroke(); }

    function drawCase(kind,{D,d,ratio}){
      const c=document.getElementById('viz');
      const g=c.getContext('2d');
      const W=c.width,H=c.height; g.clearRect(0,0,W,H);

      const col={bg:'#0b152e',obj:'#9aa5b4',rope:'#e5e7eb',metal:'#cbd5e1',dim:'#8aa3c2',text:'#e5e7eb'};
      g.fillStyle=col.bg; g.fillRect(0,0,W,H);

      const maxObj=Math.min(W*0.26,H*0.45);
      const scale=maxObj/D;
      const R=Math.max(6,(D*scale)/2);
      const ropeW=Math.max(2,d*scale);

      const cx=W*0.3,cy=H*0.6;
      const yTop=H*0.14,yBot=H*0.92;
      const left=cx-R-40,right=cx+R+40;

      g.strokeStyle=col.rope; g.lineCap='round'; g.lineJoin='round';

      if(kind==='grommetPin'){
        g.fillStyle=col.metal; g.beginPath(); g.arc(cx,cy,R,0,Math.PI*2); g.fill();
        line(g,left,yTop,left,cy-R-6,ropeW,col.rope);
        line(g,right,yTop,right,cy-R-6,ropeW,col.rope);
        arc(g,cx,cy+R+6,R+12,Math.PI,0,ropeW,col.rope);
      }
      else if(kind==='eyeShackle'){
        g.fillStyle=col.metal; g.beginPath(); g.arc(cx,cy,R*0.6,0,Math.PI*2); g.fill();
        line(g,cx,yTop,cx,cy-R*0.6-10,ropeW,col.rope);
        arc(g,cx,yTop+18,18,Math.PI,0,3,col.metal);
      }
      else if(kind==='basketObject'){
        g.fillStyle=col.metal; g.beginPath(); g.arc(cx,cy,R,0,Math.PI*2); g.fill();
        line(g,left,yBot,left,yTop,ropeW,col.rope);
        line(g,right,yBot,right,yTop,ropeW,col.rope);
        line(g,left,yTop,right,yTop,Math.max(4,ropeW*0.6),col.rope);
      }
      else if(kind==='basketPin'){
        g.fillStyle=col.metal; g.beginPath(); g.arc(cx,cy,R*0.6,0,Math.PI*2); g.fill();
        line(g,left,yBot,left,yTop,ropeW,col.rope);
        line(g,right,yBot,right,yTop,ropeW,col.rope);
        line(g,left,yTop,right,yTop,Math.max(4,ropeW*0.6),col.rope);
      }
      else if(kind==='doubleInShackle'){
        g.fillStyle=col.metal; g.beginPath(); g.arc(cx,cy,R*0.7,0,Math.PI*2); g.fill();
        line(g,right-20,yBot,right-20,yTop,ropeW,col.rope);
        line(g,right-40,yBot,right-40,yTop,ropeW,col.rope);
        line(g,left+20,yBot,left+20,yTop,ropeW,col.rope);
        line(g,left+40,yBot,left+40,yTop,ropeW,col.rope);
        line(g,left+20,yTop,right-20,yTop,Math.max(4,ropeW*0.6),col.rope);
      }

      // D/d scale band
      const bandX=W*0.62,bandY=H*0.18,bandW=W*0.30,bandH=16,span=40;
      const zones=[{a:0,b:2,c:'#ef4444',t:'<2'},{a:2,b:5,c:'#f97316',t:'2–5'},{a:5,b:25,c:'#eab308',t:'5–25'},{a:25,b:40,c:'#10b981',t:'≥25'}];
      g.fillStyle='#1f2937'; g.fillRect(bandX-6,bandY-6,bandW+12,bandH+12);
      let x=bandX; zones.forEach(z=>{const w=(Math.min(z.b,span)-Math.max(z.a,0))/span*bandW; g.fillStyle=z.c; g.fillRect(x,bandY,w,bandH); g.fillStyle='#000'; g.font='10px sans-serif'; g.fillText(z.t,x+3,bandY+12); x+=w;});
      const mx=bandX+Math.max(0,Math.min(ratio,span))/span*bandW;
      g.strokeStyle='#fff'; g.lineWidth=2; g.beginPath(); g.moveTo(mx,bandY-6); g.lineTo(mx,bandY+bandH+6); g.stroke();
      g.fillStyle=col.text; g.font='14px sans-serif'; g.fillText(`D/d = ${fmt(ratio,2)} : 1`,bandX,bandY-10);
    }

    recalc();
    ['d','D','gamma','gammaMin','case'].forEach(id=>document.getElementById(id).addEventListener('input',recalc));
  </script>
</body>
</html>
